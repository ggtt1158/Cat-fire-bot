<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Fire - Earn Money</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Monitag SDK - এটি আসল বিজ্ঞাপন দেখানোর জন্য লোড হবে -->
    <script src='//libtl.com/sdk.js' data-zone='9937367' data-sdk='show_9937367' async></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #FF6B35;
            --secondary-color: #F7931E;
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --dark-bg: #1a1a2e;
            --card-bg: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #b8b8b8;
            --border-color: #2d3561;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            /* ব্যানার ও নেভিগেশন বারের জন্য প্যাডিং */
            padding-bottom: 140px;
        }
        /* ... (বাকি CSS কোড অপরিবর্তিত) ... */
         /* VPN Warning Modal */
        .vpn-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .vpn-warning.active {
            display: flex;
        }

        .vpn-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
            border: 2px solid var(--danger-color);
        }

        .vpn-icon {
            font-size: 60px;
            color: var(--danger-color);
            margin-bottom: 20px;
        }

        .vpn-content h2 {
            color: var(--danger-color);
            margin-bottom: 15px;
        }

        .vpn-content p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Welcome Modal */
        .welcome-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .welcome-modal.active {
            display: flex;
        }

        .welcome-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .welcome-content h2 {
            font-size: 28px;
            margin-bottom: 15px;
        }

        .welcome-content p {
            font-size: 16px;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .welcome-btn {
            background: white;
            color: var(--primary-color);
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .welcome-btn:hover {
            transform: scale(1.05);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
        }

        .loading-screen.hidden {
            display: none;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Header */
        .header {
            background: var(--card-bg);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Balance Card */
        .balance-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            margin: 20px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .balance-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: var(--primary-color);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Content Container */
        .container {
            padding: 20px;
        }

        /* Task Sections */
        .task-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 24px;
        }

        /* Task Cards */
        .task-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.2);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .task-title {
            font-size: 18px;
            font-weight: bold;
        }

        .task-reward {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .task-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .task-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--dark-bg);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s;
        }

        .task-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .task-btn.completed {
            background: var(--success-color);
            color: white;
            cursor: not-allowed;
        }

        .task-btn.disabled {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-label {
            font-size: 12px;
        }

        /* Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
    </div>

    <!-- VPN Warning -->
    <div class="vpn-warning" id="vpnWarning">
        <div class="vpn-content">
            <div class="vpn-icon">⚠️</div>
            <h2>VPN সনাক্ত করা হয়েছে!</h2>
            <p>আপনার VPN চালু আছে। এই অ্যাপ ব্যবহার করতে অনুগ্রহ করে আপনার VPN বন্ধ করুন এবং পেজ রিফ্রেশ করুন।</p>
        </div>
    </div>
    
    <!-- Header -->
    <div class="header">
        <h1>🔥 Cat Fire</h1>
        <div class="user-info">
            <span id="userName">Loading...</span>
            <span>•</span>
            <span id="userId">ID: ...</span>
        </div>
    </div>

    <!-- Home Page -->
    <div class="page active" id="homePage">
        <!-- Balance Card -->
        <div class="balance-card">
            <div class="balance-label">আপনার ব্যালেন্স</div>
            <div class="balance-amount">$<span id="userBalance">0.00</span></div>
            <div class="balance-actions">
                <button class="btn btn-primary" onclick="showPage('withdrawPage')">
                    💰 Withdraw
                </button>
                <button class="btn btn-secondary" onclick="refreshBalance()">
                    🔄 Refresh
                </button>
            </div>
        </div>

        <div class="container">
            <!-- Daily Tasks Section -->
            <div class="task-section">
                <h2 class="section-title">
                    <span class="section-icon">📋</span>
                    দৈনিক টাস্ক
                </h2>

                <!-- Monetag Ad Task -->
                <div class="task-card">
                    <div class="task-header">
                        <div class="task-title">📺 Rewarded বিজ্ঞাপন দেখুন</div>
                        <div class="task-reward">$<span id="monetagReward">0.05</span></div>
                    </div>
                    <div class="task-description">
                        পুরস্কার পেতে সম্পূর্ণ বিজ্ঞাপন দেখুন
                    </div>
                    <div class="task-progress">
                        <span>আজকের অগ্রগতি</span>
                        <span><span id="monetagCount">0</span>/<span id="monetagLimit">10</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="monetagProgress" style="width: 0%"></div>
                    </div>
                    <button class="task-btn active" id="monetagBtn" onclick="watchMonetagAd()">
                        বিজ্ঞাপন দেখুন
                    </button>
                </div>

                <!-- (অন্যান্য টাস্ক কার্ড এখানে থাকবে) -->
                
            </div>
        </div>
    </div>

    <!-- (অন্যান্য Page div এখানে থাকবে) -->
    
    <!-- Banner Ad Container -->
    <div id="banner-ad-container" style="position: fixed; bottom: 70px; width: 100%; height: auto; display: flex; justify-content: center; align-items: center; z-index: 1001;">
        <!-- 
            গুরুত্বপূর্ণ: ব্যানার বিজ্ঞাপনের জন্য, আপনাকে আপনার Monitag ড্যাশবোর্ড থেকে 
            ব্যানার বিজ্ঞাপনের কোড (সাধারণত একটি ভিন্ন zone id সহ) নিয়ে এখানে বসাতে হবে।
            উদাহরণ: <script src='//libtl.com/sdk.js' data-zone='BANNER_ZONE_ID' data-sdk='show_BANNER_ZONE_ID'></script>
        -->
        <div style="background-color: #333; color: white; padding: 15px; font-size: 14px; border-top: 1px solid var(--border-color); width: 100%; text-align: center;">
            ব্যানার বিজ্ঞাপন লোড হচ্ছে...
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" data-page="homePage">
            <div class="nav-icon">🏠</div>
            <div class="nav-label">Home</div>
        </button>
        <button class="nav-item" data-page="withdrawPage">
            <div class="nav-icon">💰</div>
            <div class="nav-label">Withdraw</div>
        </button>
        <button class="nav-item" data-page="referralPage">
            <div class="nav-icon">🎁</div>
            <div class="nav-label">Refer</div>
        </button>
        <button class="nav-item" data-page="profilePage">
            <div class="nav-icon">👤</div>
            <div class="nav-label">Profile</div>
        </button>
    </div>
    
 <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyA7vbuDVd49qNePXsNCJrsMVmj-LCSH3R8",
        authDomain: "cat-fire-bot.firebaseapp.com",
        databaseURL: "https://cat-fire-bot-default-rtdb.firebaseio.com",
        projectId: "cat-fire-bot",
        storageBucket: "cat-fire-bot.firebasestorage.app",
        messagingSenderId: "320717959791",
        appId: "1:320717959791:web:8a6d191972cf263a7d939a"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Global Variables
    let userData = null;
    let adminSettings = null;

    // --- অ্যাপ চালু এবং ডেটা লোড ---
    window.addEventListener('load', initApp);

    async function initApp() {
        document.getElementById('loadingScreen').classList.remove('hidden');
        
        // VPN চেক করার প্রয়োজন হলে এখানে কোড থাকবে
        // const hasVPN = await detectVPN();

        const telegramUser = window.Telegram.WebApp.initDataUnsafe?.user;
        if (!telegramUser) {
            showNotification('টেলিগ্রাম ডেটা পাওয়া যায়নি', 'error');
            document.getElementById('loadingScreen').classList.add('hidden');
            return;
        }

        try {
            const userId = telegramUser.id.toString();
            await initializeUserIfNeeded(userId, telegramUser);
            
            // ডেটা লোড করার জন্য listener সেট করা
            db.collection('users').doc(userId).onSnapshot(doc => {
                if (doc.exists) {
                    userData = doc.data();
                    resetDailyTasksIfNeeded();
                    updateUI();
                }
            });

            db.collection('settings').doc('admin').onSnapshot(doc => {
                if (doc.exists) {
                    adminSettings = doc.data();
                    updateUI();
                }
            });
            
            // কিছুক্ষণ পর interstitial বিজ্ঞাপন দেখানোর টাইমার
            setInterval(showInterstitialAd, 120000); // ২ মিনিট পর পর

            document.getElementById('loadingScreen').classList.add('hidden');
        } catch (error) {
            console.error('App init error:', error);
            showNotification('অ্যাপ চালু হতে সমস্যা হয়েছে।', 'error');
            document.getElementById('loadingScreen').classList.add('hidden');
        }
    }

    async function initializeUserIfNeeded(userId, telegramUser) {
        const userRef = db.collection('users').doc(userId);
        const userDoc = await userRef.get();

        if (!userDoc.exists) {
            const newUserData = {
                telegramId: userId,
                firstName: telegramUser.first_name || 'User',
                balance: 1.00, // সাইনআপ বোনাস
                taskEarnings: 1.00,
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                dailyTasks: {
                    monetag: { count: 0, lastReset: new Date().toDateString() },
                    interstitial: { count: 0, lastReset: new Date().toDateString() }
                }
            };
            await userRef.set(newUserData);
        }
    }

    function resetDailyTasksIfNeeded() {
        if (!userData) return;
        const today = new Date().toDateString();
        let needsUpdate = false;
        const dailyTasks = userData.dailyTasks;

        if (dailyTasks.monetag.lastReset !== today) {
            dailyTasks.monetag = { count: 0, lastReset: today };
            needsUpdate = true;
        }
        if (!dailyTasks.interstitial || dailyTasks.interstitial.lastReset !== today) {
            dailyTasks.interstitial = { count: 0, lastReset: today };
            needsUpdate = true;
        }

        if (needsUpdate) {
            db.collection('users').doc(userData.telegramId).update({ dailyTasks });
        }
    }


    function updateUI() {
        if (!userData || !adminSettings) return;

        document.getElementById('userName').textContent = userData.firstName;
        document.getElementById('userId').textContent = `ID: ${userData.telegramId}`;
        document.getElementById('userBalance').textContent = userData.balance.toFixed(2);
        
        // টাস্ক আপডেট
        const { monetag } = userData.dailyTasks;
        const monetagLimit = adminSettings.monetagLimit || 10;
        document.getElementById('monetagReward').textContent = (adminSettings.monetagReward || 0.05).toFixed(2);
        document.getElementById('monetagLimit').textContent = monetagLimit;
        document.getElementById('monetagCount').textContent = monetag.count;
        document.getElementById('monetagProgress').style.width = `${(monetag.count / monetagLimit) * 100}%`;

        const monetagBtn = document.getElementById('monetagBtn');
        if (monetag.count >= monetagLimit) {
            monetagBtn.classList.replace('active', 'completed');
            monetagBtn.textContent = 'সম্পন্ন';
            monetagBtn.disabled = true;
        } else {
            monetagBtn.classList.replace('completed', 'active');
            monetagBtn.textContent = 'বিজ্ঞাপন দেখুন';
            monetagBtn.disabled = false;
        }
    }

    // --- বিজ্ঞাপন সম্পর্কিত ফাংশন ---

    // 1. Rewarded Ad
    async function watchMonetagAd() {
        if (!window.sdk || typeof window.sdk.rewarded.show !== 'function') {
            showNotification('বিজ্ঞাপন নেটওয়ার্ক এখনো প্রস্তুত নয়।', 'error');
            return;
        }
        
        const monetagLimit = adminSettings.monetagLimit || 10;
        if (userData.dailyTasks.monetag.count >= monetagLimit) {
            showNotification('আজকের জন্য আপনার Rewarded বিজ্ঞাপন দেখার সীমা শেষ।', 'warning');
            return;
        }

        const monetagBtn = document.getElementById('monetagBtn');
        monetagBtn.disabled = true;
        monetagBtn.textContent = 'বিজ্ঞাপন লোড হচ্ছে...';

        // আসল Monitag SDK কল করা হচ্ছে
        sdk.rewarded.show({
            onSuccess: async (result) => {
                console.log('Rewarded Ad Success:', result);
                const reward = adminSettings.monetagReward || 0.05;

                await db.collection('users').doc(userData.telegramId).update({
                    balance: firebase.firestore.FieldValue.increment(reward),
                    taskEarnings: firebase.firestore.FieldValue.increment(reward),
                    'dailyTasks.monetag.count': firebase.firestore.FieldValue.increment(1)
                });
                
                showNotification(`অভিনন্দন! আপনি $${reward.toFixed(2)} পেয়েছেন!`, 'success');
            },
            onError: (error) => {
                console.error('Rewarded Ad Error:', error);
                showNotification('বিজ্ঞাপন দেখাতে সমস্যা হয়েছে।', 'error');
                monetagBtn.disabled = false;
                monetagBtn.textContent = 'বিজ্ঞাপন দেখুন';
            }
        });
    }

    // 2. Interstitial Ad
    function showInterstitialAd() {
        if (!window.sdk || typeof window.sdk.interstitial.show !== 'function' || !userData || !adminSettings) {
            console.log('Interstitial SDK is not ready or user data not loaded.');
            return;
        }
        
        const interstitialLimit = adminSettings.interstitialLimit || 5;
        if (userData.dailyTasks.interstitial.count >= interstitialLimit) {
            console.log('Interstitial ad daily limit reached.');
            return;
        }

        console.log('Showing interstitial ad...');
        // আসল Monitag SDK কল করা হচ্ছে
        sdk.interstitial.show({
            onSuccess: async (result) => {
                console.log('Interstitial Ad Success:', result);
                // Interstitial দেখার পর কোনো পয়েন্ট যোগ হবে না, শুধু কাউন্ট বাড়বে
                await db.collection('users').doc(userData.telegramId).update({
                    'dailyTasks.interstitial.count': firebase.firestore.FieldValue.increment(1)
                });
            },
            onError: (error) => {
                console.error('Interstitial Ad Error:', error);
            }
        });
    }

    // --- অন্যান্য হেল্পার ফাংশন ---

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; background: #16213e; 
            padding: 15px 20px; border-radius: 10px; z-index: 10002;
            border-left: 4px solid ${type === 'success' ? '#4CAF50' : '#f44336'};
            color: white;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }
    
    // পেজ পরিবর্তন করার জন্য
    document.querySelectorAll('.nav-item').forEach(button => {
        button.addEventListener('click', () => {
            const pageId = button.dataset.page;
            // এই ফাংশনটি এখন নেই, তাই আপাতত লগ করা হচ্ছে
            console.log(`Navigating to ${pageId}`);
            // showPage(pageId); 
        });
    });

    async function refreshBalance() {
        await db.collection('users').doc(userData.telegramId).get();
        showNotification('ব্যালেন্স আপডেট করা হয়েছে', 'success');
    }
</script>
        
</body>
</html>

